<div class="attendance-module">
  <!-- GRADIENT BACKGROUND -->
  <div class="gradient-bg"></div>

  <!-- HEADER SECTION -->
  <div class="header-section">
    <div class="header-content">
      <div class="header-left">
        <div class="icon-wrapper">
          <i class="bi bi-calendar-check-fill"></i>
        </div>
        <div>
          <h2 class="module-title">Class Attendance Sheet</h2>
          <p class="module-subtitle">Academic Year 2025-2026 • Teacher Portal</p>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn-secondary" [disabled]="students().length === 0" (click)="saveAttendance()">
          <i class="bi bi-cloud-check-fill"></i>
          <span>Save Changes</span>
        </button>

        <button class="btn-primary" (click)="exportAttendance()">
          <i class="bi bi-file-earmark-pdf-fill"></i>
          <span>Export PDF</span>
        </button>
      </div>
    </div>
  </div>

  <!-- FILTER CARD -->
  <div class="filter-card glass-card">
    <div class="filter-row">
      <div class="filter-group">
        <label class="filter-label">
          <i class="bi bi-door-open-fill"></i>
          Select Class
        </label>
        <select class="filter-select" [ngModel]="selectedClassId()"
          (ngModelChange)="selectedClassId.set(+$event); onClassChange()">
          <option [value]="0">-- Choose a Class --</option>
          @for (cls of classes(); track cls.classid) {
          <option [value]="cls.classid">{{ cls.classname }}</option>
          }
        </select>
      </div>

      <div class="filter-group flex-grow">
        <label class="filter-label">
          <i class="bi bi-calendar-range-fill"></i>
          Time Period
        </label>
        <div class="week-picker">
          <button class="week-nav-btn" (click)="previousWeek()" title="Previous Week">
            <i class="bi bi-chevron-left"></i>
          </button>

          <div class="week-display">
            <small class="week-label">Week Starting</small>
            <div class="week-date">{{ selectedWeekStart() | date:'dd/MM/yyyy' }}</div>
            <input type="date" class="date-picker-hidden" [ngModel]="selectedWeekStart()"
              (ngModelChange)="onWeekStartChange($event)" title="Select Date" />
          </div>

          <button class="week-nav-btn" (click)="nextWeek()" title="Next Week">
            <i class="bi bi-chevron-right"></i>
          </button>

          <button class="today-btn" (click)="selectedWeekStart.set(getCurrentWeekStart()); reloadAttendanceForNewWeek()"
            title="Jump to Current Week">
            <i class="bi bi-calendar-event-fill"></i>
            <span>Today</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (selectedClassId() > 0) {
  <!-- ATTENDANCE TABLE CARD -->
  <div class="data-card glass-card">
    <div class="card-header-custom">
      <div class="header-info">
        <h5 class="class-title">
          <i class="bi bi-people-fill"></i>
          {{ getSelectedClassName() }}
        </h5>
        <div class="teacher-info">
          <i class="bi bi-person-badge-fill"></i>
          Teacher: <span class="teacher-name">{{ getSelectedTeacherName() }}</span>
        </div>
      </div>
      <span class="view-badge">Weekly View</span>
    </div>

    @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Fetching class records...</p>
    </div>
    } @else {
    <div class="table-wrapper">
      <table class="attendance-table">
        <thead>
          <!-- Row 1: Days -->
          <tr>
            <th rowspan="2" class="fixed-col col-number">No</th>
            <th rowspan="2" class="fixed-col col-student">Student Name</th>
            <th rowspan="2" class="fixed-col col-gender">Sex</th>

            @for (day of weeklySchedule; track day.day; let i = $index) {
            <th colspan="3" class="day-header">
              <div class="day-name">{{ day.day }}</div>
              <div class="day-date">{{ attendanceDates()[i] | date: 'dd/MM/yyyy' }}</div>
            </th>
            }
            <th rowspan="2" class="col-total">Total</th>
          </tr>
          <!-- Row 2: Subjects -->
          <tr style="height: 130px;">
            @for (day of weeklySchedule; track day.day) {
            @for (slot of day.slots; track slot.id; let slotIndex = $index) {
            <th class="subject-header" [class.day-separator]="slotIndex === 2">
              <p class="subject-text">
                {{ slot.name }}
              </p>
            </th>
            }
            }
          </tr>
        </thead>
        <tbody>
          @for (student of students(); track student.studentid; let i = $index) {
          <tr class="student-row">
            <td class="student-number">{{ i + 1 }}</td>
            <td class="student-name-cell">
              <div class="student-name-primary">{{ student.studentname_kh }}</div>
              <div class="student-name-secondary">{{ student.studentname_eng }}</div>
            </td>
            <td class="student-gender">
              <span class="gender-badge" [class.badge-male]="student.gender === 'M'"
                [class.badge-female]="student.gender === 'F'">
                {{ student.gender }}
              </span>
            </td>

            @for (day of weeklySchedule; track day.day; let dIndex = $index) {
            @for (slot of day.slots; track slot.id; let slotIndex = $index) {
            <td class="attendance-cell-wrapper" [class.day-separator]="slotIndex === 2">
              <div class="attendance-cell"
                (click)="toggleAttendance(student.studentid, attendanceDates()[dIndex], slot.id)">
                @if (getAttendanceStatus(student.studentid, attendanceDates()[dIndex], slot.id) === 'present') {
                <i class="bi bi-check-circle-fill status-present"></i>
                } @else if (getAttendanceStatus(student.studentid, attendanceDates()[dIndex], slot.id) === 'absent') {
                <i class="bi bi-x-circle-fill status-absent"></i>
                } @else {
                <span class="status-empty">•</span>
                }
              </div>
            </td>
            }
            }

            <td class="total-cell">{{ getPresentCount(student.studentid) }}</td>
          </tr>
          } @empty {
          <tr>
            <td [attr.colspan]="(weeklySchedule.length * 3) + 4" class="empty-state">
              <div class="empty-content">
                <i class="bi bi-people"></i>
                <p>No students found in the database for this class</p>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- STATISTICS FOOTER -->
    <div class="stats-footer">
      <div class="stat-item">
        <div class="stat-label">Total Students</div>
        <div class="stat-value">{{ attendanceStats().totalStudents }}</div>
      </div>
      <div class="stat-item stat-present">
        <div class="stat-label">Present</div>
        <div class="stat-value">{{ attendanceStats().present }}</div>
      </div>
      <div class="stat-item stat-absent">
        <div class="stat-label">Absent</div>
        <div class="stat-value">{{ attendanceStats().absent }}</div>
      </div>
      <div class="stat-item stat-rate">
        <div class="stat-label">Attendance Rate</div>
        <div class="stat-value">{{ attendanceStats().percentage }}%</div>
      </div>
    </div>
    }
  </div>
  } @else {
  <!-- EMPTY STATE -->
  <div class="empty-state-card glass-card">
    <div class="empty-state-content">
      <i class="bi bi-calendar-range"></i>
      <h4>Weekly Schedule View</h4>
      <p>Select a class to view the full weekly schedule (Mon-Sat)</p>
    </div>
  </div>
  }
</div>